<script>
    //@ts-check

    //@ts-ignore
    register("form-section", {
        state: {
            id: "",
            name: "section",
            label: "Section",
            description: "",
            hidden: false,
        },
        fields: [],
        initialized: false,
        active: false,
        hidden: false,
        init() {
            effect(() => this.active && emit("edit-section", this.state))
        },
        /** @param {CustomEvent} e */
        addField(e) {
            this.fields.push(e.detail.field.id);
    
            if (this.fieldContainer.contains(this.emptySectionElement)) {
                this.emptySectionElement.remove();
            }
        },
        /** @param {CustomEvent} e */
        removeField(e) {
            const id = e.detail.fieldId;
            this.fields = this.fields.filter((field) => field !== id);
    
            if (this.fields.length === 0) {
                this.fieldContainer.append(this.emptySectionElement);
            }
        },
        /** @param {DragEvent} e */
        drop(e) {
            e.preventDefault();
            e.stopPropagation();
    
            const target = /** @type {HTMLElement} */ (e.target);
            const templateId = /** @type {string} */ (e.dataTransfer?.getData("text/plain"));
            const elementClass = customElements.get(templateId) ?? HTMLUnknownElement
            const newEl = new elementClass();
    
            if (target === this.fieldContainer) {
                this.fieldContainer.appendChild(newEl);
            } else {
                const insertLocation = /** @type {InsertPosition} */ (target.dataset.insertLocation);
                target.parentElement?.insertAdjacentElement(insertLocation, newEl);
            }
        }
    })
</script>

<template id="form-section"
    on:pointerdown="$.active = true"
    on:pointerdown.global="$.active = false"
    on:pointerover.stop="$.hovering = true"
    on:pointerout.stop="$.hovering = false"
    on:dragstart="emit.global:moving-section"
    on:dragend="emit.global:moved-section"
    on:delete="delete"
>
    <container-highlight
        $.fieldState="$$.state"
        $.fieldName="$$.name"
        $.active="$$.active"
        $.visible="$$.active|$$.hovering"
        class="block absolute inset-0 cursor-pointer transition border border-sky-500"
    ></container-highlight>
    <div>
        <h2 class="font-semibold text-2xl mb-1">[[$.label]]</h2>
        <div
            .hidden="$.description==''"
            class="col-span-full break-all"
        >
            [[$.description]]
        </div>
    </div>
    <div
        on:(pointerdown|pointerover|pointerout).stop
        on:dragover.prevent
        on:drop="drop"
        class="grid grid-cols-1 @[35rem]/form:grid-cols-1 gap-4"
    >
        <div class="grid justify-items-center gap-3 p-6 text-base rounded bg-slate-400/10 dark:bg-white/10" inert>
            <svg class="h-8 w-8" viewBox="0 0 494 492"><use href="#section-drag-icon" /></svg>
            <div>Drag an element here</div>
        </div>
    </div>
    <container-drop-zone
        on:move-section[target:this]="$.visible:true"
        on:moved-section="$.visible:false"
        class="absolute -top-4 left-0 right-0 bottom-1/2 text-xs text-white" insert-location="beforebegin"
    >
        <div class="absolute -top-0.5 -right-1 -left-1 flex justify-center h-1 rounded-full bg-sky-500" inert>
            <div class="absolute top-1/2 -translate-y-1/2 px-2 pb-0.5 rounded-full bg-sky-500">Drop Item Here</div>
        </div>
    </container-drop-zone>
    <container-drop-zone
        on:move-section[target:this]="$.visible = true"
        on:moved-section="$.visible = false"
        class="absolute top-1/2 left-0 right-0 -bottom-4 text-xs text-white" data-insert-location="afterend"
    >
        <div class="absolute -bottom-0.5 -right-1 -left-1 flex justify-center h-1 rounded-full bg-sky-500" inert>
            <div class="absolute top-1/2 -translate-y-1/2 px-2 pb-0.5 rounded-full bg-sky-500">Drop Item Here</div>
        </div>
    </container-drop-zone>
</template>