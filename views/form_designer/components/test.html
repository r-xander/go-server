<script>
    //@ts-check

const formSection = {
    data: {
        id: nextSectionId(),
        name: "section",
        label: "Section",
        description: "",
        hidden: false,
    },
    fields: [],
    initialized: false,
    active: false,
    hidden: false,
}

function init() {
    
}
        
/** @param {CustomEvent} e */
function addField(el, e) {
    el.fields.push(e.detail.field.id);
    
    if (this.fieldContainer.contains(this.emptySectionElement)) {
        this.emptySectionElement.remove();
    }
}
 
/** @param {CustomEvent} e */
function removeField(el, e) {
    const id = e.detail.fieldId;
    el.fields = el.fields.filter((field) => field !== id);

    if (this.fields.length === 0) {
        this.fieldContainer.append(this.emptySectionElement);
    }
}

/** @param {DragEvent} e */
function drop(e) {
    e.preventDefault();
    e.stopPropagation();

    const target = /** @type {HTMLElement} */ (e.target);
    const templateId = /** @type {string} */ (e.dataTransfer?.getData("text/plain"));
    const elementClass = customElements.get(templateId) ?? HTMLUnknownElement
    const newEl = new elementClass();

    if (target === this.fieldContainer) {
        this.fieldContainer.appendChild(newEl);
    } else {
        const insertLocation = /** @type {InsertPosition} */ (target.dataset.insertLocation);
        target.parentElement?.insertAdjacentElement(insertLocation, newEl);
    }
}

const configuredEvents = {}
const eventMap = new WeakMap();
const eventBoundries = new WeakSet();

function registerEvent(eventType, listenerEl, handlerEl, callback, modifiers) {
    if (!configuredEvents[eventType]) {
        document.addEventListener(eventType, (event) => runEvent(event, eventType))
        configuredEvents[eventType] = true
    }

    let elEvents = eventMap.get(listenerEl)
    if (elEvents === undefined) {
        elEvents = {}
        eventMap.set(listenerEl, elEvents)
    }

    const callbacks = elEvents[eventType] ?? (elEvents[eventType] = [])
    callbacks.push(callback)
}

function runEvent(event, eventType) {
    let target = event.target;

    while (!eventBoundries.has(target) && target !== document.body) {
        const targetData = eventMap.get(target);
        const handlerData = targetData?.get(eventType);

        if (handlerData !== undefined) {
            handlerData.execute(target, event);
            if (handlerData.modifiers.stop) {
                event.stopPropagation();
                break;
            }
        }

        target = target.parentElement;
    }
}

function emit(el, eventType, data, modifiers) {
    const event = new CustomEvent(eventType, { detail : data, bubbles: true, cancelable: true })
    
    if (modifiers.global) {
        el = window
    }

    el.dispatchEvent(event)
}

const events = {
    component: {
        pointerdown: (el, e) => emit(el, "edit-field", null, true),
        dragstart: (el, e) => emit(el, "moving-section", null, true),
        dragend: (el, e) => emit(el, "moved-section", null, true),
        delete: () => deleteSection(this),
        "add-field": (el, e) => addField(el, e),
        "remove-field": (el, e) => removeField(el, e)
    },
    highlight: {
        pointerdown: () => {

        }
    }
}

registerEvent("pointerdown", window, "highlight", (el, e) => emit(el, "not-active"), { outside: true })
</script>



<form-section
    &::pointerdown::emit.global[edit-field]
    &::dragstart::emit.global[moving-section]
    &::dragend::emit.global[moved-section]
    &::delete::run[delete]
    &::add-field::run[addField]
    &::remove-field::run[removeField]
>
    <container-highlight 
        $::pointerdown.outside::emit[not-active]
        $::pointerdown::emit[active]
        $::pointerover.stop::emit[hovering]
        $::pointerout.stop::emit[hovering]
        $::state-change[hidden|name]::passthrough
        class="block absolute inset-0 cursor-pointer transition border border-sky-500"
        event-target="hightlight"
    ></container-highlight>
    <div>
        <h2
            class="font-semibold text-2xl mb-1"
            event-target="label"
        >
            [[ $::state-change[label]::#value ]]
        </h2>
        <div
            $::state-change[description]="&.classList.toggle('hidden', none(#value))"
            class="col-span-full break-all"
        >
            [[ $::state-change[description]::#value ]]
        </div>
    </div>
    <div
        &::[pointerdown|pointerover|pointerout].stop
        &::dragover.prevent
        &::drop::run[drop]
        class="grid grid-cols-1 @[35rem]/form:grid-cols-1 gap-4"
    >
        <div
            $::[add-field|remove-field]::class.toggle(empty(&.children))="hidden"
            class="grid justify-items-center gap-3 p-6 text-base rounded bg-slate-400/10 dark:bg-white/10" 
            inert
        >
            <svg class="h-8 w-8" viewBox="0 0 494 492"><use href="#section-drag-icon" /></svg>
            <div>Drag an element here</div>
        </div>
    </div>
    <div
        global::[moving-section|moved-section](not(#target|$))::class.toggle="hidden"
        class="hidden absolute -top-4 left-0 right-0 bottom-1/2 text-xs text-white"
        insert-location="beforebegin"
    >
        <div class="absolute -top-0.5 -right-1 -left-1 flex justify-center h-1 rounded-full bg-sky-500" inert>
            <div class="absolute top-1/2 -translate-y-1/2 px-2 pb-0.5 rounded-full bg-sky-500">
                Drop Item Here
            </div>
        </div>
    </div>
    <div
        global::[moving-section|moved-section]::not(#target|$)::class.toggle="hidden"
        class="hidden absolute top-1/2 left-0 right-0 -bottom-4 text-xs text-white"
        data-insert-location="afterend"
    >
        <div 
            class="absolute -bottom-0.5 -right-1 -left-1 flex justify-center h-1 rounded-full bg-sky-500"
            inert
        >
            <div class="absolute top-1/2 -translate-y-1/2 px-2 pb-0.5 rounded-full bg-sky-500">
                Drop Item Here
            </div>
        </div>
    </div>
</form-section>


<container-highlight
    &::[active|not-active]::class.toggle="bg-sky-500/20"
    &::not-active::class.add="invisible"
>
    <div class="absolute -left-px bottom-full font-mono flex py-0.5 px-3 gap-3 text-xs text-white bg-sky-500">
        <span class="font-bold italic cursor-default select-none">[[ $::state-change::set(#state.name) ]]</span>
        <span
            $::state-change::none(#state.state)::class.toggle="hidden"
            class="opacity-80"
        >
            [[ $::state-change::set(#state.state) ]]
        </span>
    </div>
    <div class="absolute -right-px bottom-full flex gap-1">
        <button
            $::click::emit(copy-modal-open)
            class="p-1 transition bg-sky-500 text-white hover:bg-sky-600"
        >
            <svg class="w-3 h-3"><use href="#copy-icon" /></svg>
        </button>
        <button
            $::click::emit(delete-modal-open)
            class="p-1 transition bg-sky-500 text-white hover:bg-sky-600"
        >
            <svg class="w-3 h-3"><use href="#delete-icon" /></svg>
        </button>
    </div>
    <div 
        $::delete::style.display[none]::set
        &::pointerdown.outside::style.display[none]::remove
        class="grid gap-4 items-center w-max p-4 absolute top-0 -right-0.5 z-50 text-sm shadow-md rounded-md bg-white border border-neutral-200 dark:bg-aux-dark dark:border-aux-dark"
    >
        <h1>Are you sure you want to copy this field?</h1>
        <div class="flex gap-2 justify-self-end">
            <button
                &::click::emit(delete)
                class="px-3 py-1.5 rounded transition-all text-white bg-sky-500 hover:bg-sky-600 outline-sky-300/60 dark:bg-opacity-80 dark:hover:bg-opacity-70"
            >
                Copy
            </button>
            <button
                $::click::emit(delete-modal-close).internal
                class="px-3 py-1.5 rounded border transition-all border-neutral-200 text-neutral-600 hover:bg-neutral-100 dark:text-white/80 dark:border-[#555] dark:hover:text-white/90 dark:hover:bg-[#3e3e3e]"
            >
                Cancel
            </button>
        </div>
    </div>
    <div 
        $::delete::style.display[none]::set
        &::pointerdown.outside::style.display[none]::remove
        class="grid gap-4 items-center w-max p-4 absolute top-0 -right-0.5 z-50 text-sm shadow-md rounded-md bg-white border border-neutral-200 dark:bg-aux-dark dark:border-aux-dark"
    >
        <h1>Are you sure you want to delete this field?</h1>
        <div class="flex gap-2 justify-self-end">
            <button
                &::click::emit[delete]
                class="px-3 py-1.5 rounded transition-all text-white bg-rose-500 hover:bg-rose-600 outline-rose-300/60 dark:bg-opacity-80 dark:hover:bg-opacity-70"
            >
                Delete
            </button>
            <button
                $::click::emit.internal[delete-modal-close]
                class="px-3 py-1.5 rounded border transition-all border-neutral-200 text-neutral-600 hover:bg-neutral-100 dark:text-white/80 dark:border-[#555] dark:hover:text-white/90 dark:hover:bg-[#3e3e3e]"
            >
                Cancel
            </button>
        </div>
    </div>
</container-highlight>